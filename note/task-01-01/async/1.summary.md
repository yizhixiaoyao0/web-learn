# 同步模式/异步模式


> 众所周知， javascript采用单线程模式工作，其原因与js最早设计初衷有关。<br/>
最早javascript是运行在浏览器端的脚本语言，是为了实现页面上的动态交互，而实现页
面交互的核心就是DOM操作，这也就决定了必须使用单线程模型，否则就会出现复杂的
线程同步问题。为了避免这个线程同步问题，js从一开始就被设计为单线程工作。

* 单线程指的是在js中执行环境中负责执行代码的只有一个；

    * 优点是更安全更简单；

    * 缺点是若遇到特别耗时的任务，后面的任务必须排队等待这个任务结束，就会造成假死的情况；

* javascript将任务的模式分为同步模式和异步模式（为了解决耗时任务问题）；

    * 同步模式和异步模式在表象上的差异以及各自存在的意义；

    * javascript单线程如何实现的异步模式（时间循环和消息队列）；

    * javascript异步编程的方法；

    * ES2015提供的Promise、其中牵扯到的宏任务和微任务；

    * ES2015提供的Generator、ES2017提供的async/await方法；

###  同步模式
> 代码中的任务依次执行，后一个任务必须等前一个任务结束才能执行；<br/>
程序的执行顺序与代码编写顺序完全一致；<br/>
单线程下大多数任务都是同步模式执行（同步指的是排队执行）

* 例： 

  ```
  console.log('global begin');
  function bar() {
    console.log('bar task');
  }
  function foo() {
    console.log('bar task');
    bar();
  }
  foo();
  console.log('global end');
  ```

  1. 开始执行，js执行引擎会把我们全部代码加载进来；

  2. 在调用栈压入一个匿名调用，可以理解为把所有代码放入一个匿名函数中执行，开始逐行执行；

  3. 将第一行console.log压入调用栈执行，控制台打印相应信息，调用结束弹出调用栈；

  4. 函数声明，不会产生调用，调用继续往下；

  5. foo函数压入调用栈， 一开始打印消息，弹出console，调用bar，压入栈，执行console，弹出bar， 弹出foo；

  6. 压入console.log, 打印完成，调用栈清空；

* 排队执行机制存在的问题
  
  > 某一行代码执行时间过长，后面的任务会延迟，这种延迟称为阻塞;<br/>
  因此必须要有异步模式来解决程序无法避免的耗时操作;



### 异步模式
> 异步模式api不回去等待这个任务结束才开始下一个任务，开启过后就立即往后执行下一个任务；<br/>
后续逻辑一般会通过回调函数的方式定义；<br/>
可实现同时处理大量耗时任务；<br/>
代码执行顺序混乱;

  * eventloop 用来监听调用栈和消息队列，当调用栈任务结束，时间循环就会从消息队列中取出第一个任务压入调用栈

* 例： 

    ```
    console.log('global begin');

    setTimeout(() => {
      console.log('time1 invoke')
    }, 1800);

    setTimeout(() => {
      console.log('time2 invoke')
      setTimeout(() => {
        console.log('inner invoke')
      }, 1000);
    }, 1000);

    console.log('global end');

    ```
  1. 开始执行，js执行引擎会把我们全部代码加载进来；

  2. 在调用栈压入一个匿名调用，可以理解为把所有代码放入一个匿名函数中执行，开始逐行执行； 

  3. 将第一行console.log压入调用栈执行，控制台打印相应信息，调用结束弹出调用栈；

  4. 压入settimeout，settimeout函数内部为异步调用，放入api环境，不受js线程影响， 弹栈；

  5. 压入settimeout， 放入web api， 弹栈；

  6. 压入console，打印完成后弹出；

  7. event loop监听调用栈和消息队列， 调用栈所有任务结束，时间循环从消息队列取出第一个任务time2压入调用栈；

  8. 执行过程与以上一致， ....


* javascript是单线程，浏览器并不是单线程的，js调用的某些内部api不一定是单线程；

* 同步和异步模式指的是， 运行环境提供的api是以同步还是异步模式的方式工作；
